## library
library(tidyverse)
## import and pre-process cohort data
df_input <- read_csv(
here::here("output", "input.csv"))
library(here)
## import and pre-process cohort data
df_input <- read_csv(
here::here("output", "input.csv"))
View(df_input)
df_cleaned <- df_input %>%
mutate(GroupVidClinic_had=ifelse(is.na(GroupVidClinic_had)|GroupVidClinic_instance==0,0,1))
df_cleaned <- df_input %>%
mutate(GroupVidClinic_had=ifelse(is.na(GroupVidClinic_instance)|GroupVidClinic_instance==0,0,1))
df_to_tbrates <- function(mydf,myvars,flag_save=0,tb_name="latest") {
mytb=
mydf %>%
group_by_at(myvars) %>%
summarise(
population=n(),
GroupVidClinic_covg=sum(GroupVidClinic_had,na.rm=T),
GroupVidClinic_count=sum(GroupVidClinic_instance,na.rm=T),
)
if (flag_save){
write.csv(mytb,paste0(here::here("output","tables"),"/",tb_name,".csv"))
}
return(mytb)
}
## OC and GP rates per practice
tb01_tally_practice <- df_to_tbrates(df_cleaned,c("practice"),1,"tb01_gpcr_region")
## OC and GP rates per STP
tb02_gpcr_stp <- df_to_tbrates(df_cleaned,c("stp"),1,"tb02_gpcr_stp")
mytb=
mydf %>%
group_by_at("practice") %>%
summarise(
population=n(),
GroupVidClinic_covg=sum(GroupVidClinic_had,na.rm=T),
GroupVidClinic_count=sum(GroupVidClinic_instance,na.rm=T),
)
mytb=
df_cleaned %>%
group_by_at("practice") %>%
summarise(
population=n(),
GroupVidClinic_covg=sum(GroupVidClinic_had,na.rm=T),
GroupVidClinic_count=sum(GroupVidClinic_instance,na.rm=T),
)
df_to_tbrates <- function(mydf,myvars,flag_save=0,tb_name="latest") {
mytb=
mydf %>%
group_by_at(myvars) %>%
summarise(
population=n(),
GroupVidClinic_covg=sum(GroupVidClinic_had,na.rm=T),
GroupVidClinic_count=sum(GroupVidClinic_instance,na.rm=T),
)
if (flag_save){
write.csv(mytb,paste0(here::here("output"),"/",tb_name,".csv"))
}
return(mytb)
}
## OC and GP rates per practice
tb01_tally_practice <- df_to_tbrates(df_cleaned,c("practice"),1,"tb01_gpcr_region")
## OC and GP rates per STP
tb02_gpcr_stp <- df_to_tbrates(df_cleaned,c("stp"),1,"tb02_gpcr_stp")
## OC and GP rates per STP
tb02_tally_stp <- df_to_tbrates(df_cleaned,c("stp"),1,"tb02_gpcr_stp")
View(tb01_tally_practice)
View(tb01_tally_stp)
View(tb02_tally_stp)
# ##==============================================================================
# Analysis filename:			01-createtallytables
# Project:				Pilot on video group clinics
# Author:					MF
# Date: 					22/12/2020
# Version: 				R
# Description:	Produce tally on video group clinics
# Output to csv files
# Datasets used:			input.csv
# Datasets created: 		None
# Other output: tables: 'tb*.csv'
# Log file: log-01-createtallytable
#
## ==============================================================================
## open log connection to file
sink(here::here("logs", "log-01-createtallytable.txt"))
## library
library(tidyverse)
library(here)
## import and pre-process cohort data
df_input <- read_csv(
here::here("output", "input.csv"))
df_cleaned <- df_input %>%
mutate(GroupVidClinic_had=ifelse(is.na(GroupVidClinic_instance)|GroupVidClinic_instance==0,0,1))
## Rates per characteristic
df_to_tbrates <- function(mydf,myvars,flag_save=0,tb_name="latest") {
mytb=
mydf %>%
group_by_at(myvars) %>%
summarise(
population=n(),
GroupVidClinic_covg=sum(GroupVidClinic_had,na.rm=T),
GroupVidClinic_count=sum(GroupVidClinic_instance,na.rm=T),
)
if (flag_save){
write.csv(mytb,paste0(here::here("output"),"/",tb_name,".csv"))
}
return(mytb)
}
## OC and GP rates per practice
tb01_tally_practice <- df_to_tbrates(df_cleaned,c("practice"),1,"tb01_gpcr_region") ### !!! Can we make these non pseudo_id's in cohort extractor? i.e. actual practice codes?
## OC and GP rates per STP
tb02_tally_stp <- df_to_tbrates(df_cleaned,c("stp"),1,"tb02_gpcr_stp")
## close log connection
sink()
## open log connection to file
sink(here::here("logs", "log-02-createtallytable.txt"))
## library
library(tidyverse)
library(here)
## import and pre-process cohort data
df_input <- read_csv(
here::here("output", "input_codes.csv"))
df_cleaned <- df_input %>%
mutate(GVC01_had=ifelse(is.na(GVC01_instance)|GVC01_instance==0,0,1),
GVC02_had=ifelse(is.na(GVC02_instance)|GVC02_instance==0,0,1),
GVC03_had=ifelse(is.na(GVC03_instance)|GVC03_instance==0,0,1),
practice=factor(practice),
stp=factor(stp),
patient_id=factor(patient_id)
)
View(df_cleaned)
## National tally - no. instances and no. individual patients with instances
tb01_nat_tally <- df_cleaned %>% summarise(across(where(is.numeric),~sum(.x,na.rm=T)))
tb01_nat_tally <- tb01_nat_tally %>% mutate(population=nrow(df_cleaned))
View(tb01_nat_tally)
View(tb01_nat_tally)
## Practice tally - no practices with at least an instance
tb02_pratice_flags <- df_cleaned %>% group_by(practice) %>% summarise_at(vars(ends_with("had")), ~ ifelse(sum(.)>0,1,0))
View(tb02_practice_flags)
View(tb02_practice_flags)
tb02_pratice_flags
print(tb02_practice_flags)
## Practice tally - no practices with at least an instance
tb02_pratice_flags <- df_cleaned %>% group_by(stp,practice) %>% summarise_at(vars(ends_with("had")), ~ ifelse(sum(.)>0,1,0))
View(tb02_practice_flags)
print(tb02_practice_flags)
View(tb02_pratice_flags)
View(tb02_pratice_flags)
View(tb02_practice_flags)
## Practice tally - no practices with at least an instance
tb02_practice_flags <- df_cleaned %>% group_by(stp,practice) %>% summarise_at(vars(ends_with("had")), ~ ifelse(sum(.)>0,1,0))
View(tb02_practice_flags)
## STP tally - no STPs with at least an instance
tb03_stp_flags <- df_cleaned %>% group_by(stp) %>% summarise_at(vars(ends_with("had")), ~ ifelse(sum(.)>0,1,0))
View(tb03_stp_flags)
## Save
write.csv(tb01_nat_tally,paste0(here::here("output"),"/tb01_nat_tally.csv"))
write.csv(tb02_pratice_flags,paste0(here::here("output"),"/tb02_practice_flags.csv"))
write.csv(tb03_stp_flags,paste0(here::here("output"),"/tb01_stp_flags.csv"))
## close log connection
sink()
View(tb01_nat_tally)
