df_summary <- df_input %>%
group_by(month) %>%
summarise(GVC01=sum(GVC01_instance,na.rm=T),
GVC02=sum(GVC02_instance,na.rm=T),
GVC03=sum(GVC03_instance,na.rm=T),
GVCcomparator_GPconsult=sum(GVCcomparator_consult_count,na.rm=T))
View(df_summary)
df_summary_long <- df_summary %>% pivot_longer(cols=starts_with("GVC"),
names_to="Code",
values_to="Count")
ggplot(data=df_summary_long,aes(x=month,y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
theme(axis.text.x = element_text(angle = -45))
ggplot(data=df_summary_long,aes(x=month,y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
scale_x_date(date_breaks = "2 months",expand=c(0,0))  +
theme(axis.text.x = element_text(angle = -45))
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
scale_x_date(date_breaks = "2 months",expand=c(0,0))  +
theme(axis.text.x = element_text(angle = -45))
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
scale_x_date(date_breaks = "2 months",expand=c(0,0))  +
theme(axis.text.x = element_text(angle = -90))
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
scale_x_date(date_breaks = "2 months",expand=c(0,0))  +
theme(axis.text.x = element_text(angle = -90,hjust = 1))
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
scale_x_date(date_breaks = "2 months",expand=c(0,0))  +
theme(axis.text.x = element_text(angle = -90,hjust = 10))
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
scale_x_date(date_breaks = "2 months",expand=c(0,0))  +
theme(axis.text.x = element_text(angle = -90,vjust = 10))
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
scale_x_date(date_breaks = "2 months",expand=c(0,0))  +
theme(axis.text.x = element_text(angle = -90,vjust = -1))
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
scale_x_date(date_breaks = "2 months",expand=c(0,0))  +
theme(axis.text.x = element_text(angle = -90,vjust = 0))
ggsave(paste0(here::here("output"),"/sc03_fig01_nattrends.png"),width = 40, height = 20, dpi=300,units ="cm")
## open log connection to file
sink(here::here("logs", "log-03-createnattrends.txt"))
## library
library(tidyverse)
library(here)
query_dates=seq(as.Date("2019-07-01"),length=18,by="months")
query_dates <- paste0(query_dates)
df_input <- read_csv(
here::here("output",paste0("input_measures_",  query_dates[1], ".csv")))
df_input <- df_input %>% mutate(month=query_dates[1])
for (datenow in tail(query_dates,-1)){
df_input_now <- read_csv(
here::here("output",paste0("input_measures_",  datenow, ".csv")))
df_input_now <- df_input_now %>% mutate(month=datenow)
df_input <- df_input %>% bind_rows(df_input_now)
}
df_input <- as.data.frame(df_input)
df_summary <- df_input %>%
group_by(month) %>%
summarise(GVC01=sum(GVC01_instance,na.rm=T),
GVC02=sum(GVC02_instance,na.rm=T),
GVC03=sum(GVC03_instance,na.rm=T),
GVCcomparator_GPconsult=sum(GVCcomparator_consult_count,na.rm=T))
df_summary_long <- df_summary %>% pivot_longer(cols=starts_with("GVC"),
names_to="Code",
values_to="Count")
write.csv(df_summary_long,paste0(here::here("output"),"/sc03_tb01_nattrends.csv"))
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
scale_x_date(date_breaks = "2 months",expand=c(0,0))  +
theme(axis.text.x = element_text(angle = -90,vjust = 0))
ggsave(paste0(here::here("output"),"/sc03_fig01_nattrends.png"),width = 40, height = 20, dpi=300,units ="cm")
## close log connection
sink()
## open log connection to file
sink(here::here("logs", "log-02-createtallytable.txt"))
## library
library(tidyverse)
library(here)
## import and pre-process cohort data
df_input <- read_csv(
here::here("output", "input_codes.csv"))
df_cleaned <- df_input %>%
mutate(GVC01_had=ifelse(is.na(GVC01_instance)|GVC01_instance==0,0,1),
GVC02_had=ifelse(is.na(GVC02_instance)|GVC02_instance==0,0,1),
GVC03_had=ifelse(is.na(GVC03_instance)|GVC03_instance==0,0,1),
practice=factor(practice),
stp=factor(stp),
patient_id=factor(patient_id)
)
## National tally - no. instances and no. individual patients with instances
tb01_nat_tally <- df_cleaned %>% summarise(across(where(is.numeric),~sum(.x,na.rm=T)))
tb01_nat_tally <- tb01_nat_tally %>% mutate(population=nrow(df_cleaned),no_practices=n_distinct(df_cleaned$practice,na.rm=T))
## Practice tally - no practices with at least an instance
tb02_practice_flags <- df_cleaned %>% group_by(stp,practice) %>% summarise_at(vars(ends_with("had")), ~ ifelse(sum(.)>0,1,0))
tb02_practice_flags_ <- pivot_longer(tb02_practice_flags,cols=c("GVC01_had","GVC02_had","GVC03_had"),
names_to="code",
values_to="had_instance")
tb02_practice_flags_ <- tb02_practice_flags_ %>%
group_by(code) %>%
summarise(Present=sum(had_instance),Absent=n()-Present) %>%
pivot_longer(c("Present","Absent"),names_to="Instance presence",values_to="no_practices")
tb02_practice_flags_$`Instance presence` <- factor(tb02_practice_flags_$`Instance presence`)
ggplot(tb02_practice_flags_, aes(fill=`Instance presence`,x=code, y=no_practices,label=no_practices)) +
geom_bar( stat="identity")+
geom_text(aes(vjust=-1),position = position_stack(vjust = 0.2))+
theme(axis.text.x = element_text(angle = -45),text = element_text(size=17))+
labs(title="Portion of practices with code recorded",y="Count of practices",x="Code")
ggsave(paste0(here::here("output"),"/sc02_fig01_practice_flags.png"),width = 40, height = 20, dpi=300,units ="cm")
## STP tally - no STPs with at least an instance
tb03_stp_flags <- df_cleaned %>% group_by(stp) %>% summarise_at(vars(ends_with("had")), ~ ifelse(sum(.)>0,1,0))
## Save
write.csv(tb01_nat_tally,paste0(here::here("output"),"/sc02_tb01_nat_tally.csv"))
write.csv(tb02_pratice_flags,paste0(here::here("output"),"/sc02_tb02_practice_flags.csv"))
View(tb02_practice_flags)
View(tb02_practice_flags_)
write.csv(tb02_practice_flags,paste0(here::here("output"),"/sc02_tb02_practice_flags.csv"))
write.csv(tb03_stp_flags,paste0(here::here("output"),"/sc02_tb03_stp_flags.csv"))
## close log connection
sink()
?pivot_wider
df_cleaned <- df_input %>%
pivot_longer(cols=starts_with("GVC"),
names_to="Code",
values_to="Instances") %>%
mutate("Had"=ifelse(is.na(Instances)|Instances==0,0,1)) %>%
pivot_wider(names_from=Code,values_from(Instances,Had))
df_cleaned <- df_input %>%
pivot_longer(cols=starts_with("GVC"),
names_to="Code",
values_to="Instances") %>%
mutate("Had"=ifelse(is.na(Instances)|Instances==0,0,1)) %>%
pivot_wider(names_from=Code,values_from=c(Instances,Had))
View(df_cleaned)
## open log connection to file
sink(here::here("logs", "log-02-createtallytable.txt"))
## library
library(tidyverse)
library(here)
## import and pre-process cohort data
df_input <- read_csv(
here::here("output", "input_codes.csv"))
df_cleaned <- df_input %>%
pivot_longer(cols=starts_with("GVC"),
names_to="Code",
values_to="Instances") %>%
mutate("Had"=ifelse(is.na(Instances)|Instances==0,0,1)) %>%
pivot_wider(names_from=Code,values_from=c(Instances,Had)) %>%
mutate(practice=factor(practice),
stp=factor(stp),
patient_id=factor(patient_id)
)
View(df_cleaned)
## National tally - no. instances and no. individual patients with instances
tb01_nat_tally <- df_cleaned %>% summarise(across(where(is.numeric),~sum(.x,na.rm=T)))
View(tb01_nat_tally)
tb01_nat_tally <- tb01_nat_tally %>% mutate(population=nrow(df_cleaned),no_practices=n_distinct(df_cleaned$practice,na.rm=T))
View(tb01_nat_tally)
## Practice tally - no practices with at least an instance
tb02_practice_flags <- df_cleaned %>% group_by(stp,practice) %>% summarise_at(vars(starts_with("Had")), ~ ifelse(sum(.)>0,1,0))
tb02_practice_flags_ <- pivot_longer(tb02_practice_flags,cols=c("GVC01_had","GVC02_had","GVC03_had"),
names_to="code",
values_to="had_instance")
View(tb02_practice_flags)
tb02_practice_flags_ <- pivot_longer(tb02_practice_flags,cols=vars(starts_with("Had")),
names_to="code",
values_to="had_instance")
tb02_practice_flags_ <- pivot_longer(tb02_practice_flags,cols=starts_with("Had"),
names_to="code",
values_to="had_instance")
tb02_practice_flags_ <- tb02_practice_flags_ %>%
group_by(code) %>%
summarise(Present=sum(had_instance),Absent=n()-Present) %>%
pivot_longer(c("Present","Absent"),names_to="Instance presence",values_to="no_practices")
tb02_practice_flags_$`Instance presence` <- factor(tb02_practice_flags_$`Instance presence`)
ggplot(tb02_practice_flags_, aes(fill=`Instance presence`,x=code, y=no_practices,label=no_practices)) +
geom_bar( stat="identity")+
geom_text(aes(vjust=-1),position = position_stack(vjust = 0.2))+
theme(axis.text.x = element_text(angle = -45),text = element_text(size=17))+
labs(title="Portion of practices with code recorded",y="Count of practices",x="Code")
ggplot(tb02_practice_flags_, aes(fill=`Instance presence`,x=code, y=no_practices,label=no_practices)) +
geom_bar( stat="identity")+
geom_text(aes(vjust=-1),position = position_stack(vjust = 0.2))+
theme(axis.text.x = element_text(angle = -45),text = element_text(size=15))+
labs(title="Portion of practices with code recorded",y="Count of practices",x="Code")
ggplot(tb02_practice_flags_, aes(fill=`Instance presence`,x=code, y=no_practices,label=no_practices)) +
geom_bar( stat="identity")+
geom_text(aes(vjust=-1),position = position_stack(vjust = 0.2))+
theme(axis.text.x = element_text(angle = -90),text = element_text(size=15))+
labs(title="Portion of practices with code recorded",y="Count of practices",x="Code")
ggsave(paste0(here::here("output"),"/sc02_fig01_practice_flags.png"),width = 40, height = 20, dpi=300,units ="cm")
## STP tally - no STPs with at least an instance
tb03_stp_flags <- df_cleaned %>% group_by(stp) %>% summarise_at(vars(ends_with("had")), ~ ifelse(sum(.)>0,1,0))
## Save
write.csv(tb01_nat_tally,paste0(here::here("output"),"/sc02_tb01_nat_tally.csv"))
write.csv(tb02_practice_flags,paste0(here::here("output"),"/sc02_tb02_practice_flags.csv"))
write.csv(tb03_stp_flags,paste0(here::here("output"),"/sc02_tb03_stp_flags.csv"))
View(tb02_practice_flags)
## open log connection to file
sink(here::here("logs", "log-03-createnattrends.txt"))
## library
library(tidyverse)
library(here)
query_dates=seq(as.Date("2019-07-01"),length=18,by="months")
query_dates <- paste0(query_dates)
df_input <- read_csv(
here::here("output",paste0("input_measures_",  query_dates[1], ".csv")))
df_input <- df_input %>% mutate(month=query_dates[1])
for (datenow in tail(query_dates,-1)){
df_input_now <- read_csv(
here::here("output",paste0("input_measures_",  datenow, ".csv")))
df_input_now <- df_input_now %>% mutate(month=datenow)
df_input <- df_input %>% bind_rows(df_input_now)
}
df_input <- as.data.frame(df_input)
rm(df_input_now)
df_summary <- df_input %>%
group_by(month) %>%
summarise(GVC01=sum(GVC01_instance,na.rm=T),
GVC02=sum(GVC02_instance,na.rm=T),
GVC03=sum(GVC03_instance,na.rm=T),
GVCcomparator_GPconsult=sum(GVCcomparator_consult_count,na.rm=T))
View(head(df_input))
df_summary <- df_input %>%
group_by(month) %>%
summarise_at(vars(starts_with("GVC")),.~sum(.,na.rm=T))
df_summary <- df_input %>%
group_by(month) %>%
summarise_at(vars(starts_with("GVC")),~sum(.,na.rm=T))
View(df_summary)
rm(df_input)
df_summary_long <- df_summary %>% pivot_longer(cols=starts_with("GVC"),
names_to="Code",
values_to="Count")
View(df_summary_long)
write.csv(df_summary_long,paste0(here::here("output"),"/sc03_tb01_nattrends.csv"))
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
scale_x_date(date_breaks = "2 months",expand=c(0,0))  +
theme(axis.text.x = element_text(angle = -90,vjust = 0))
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,color=Code)) +
geom_point()
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,color=Code)) +
geom_line()
ggsave(paste0(here::here("output"),"/sc03_fig02_nattrends.png"),width = 40, height = 20, dpi=300,units ="cm")
## close log connection
sink()
# ##==============================================================================
# Analysis filename:			03-createnattrends_codes
# Project:				Pilot on video group clinics
# Author:					MF
# Date: 					17/01/2020
# Version: 				R
# Description:	Produce tally on instances of relevant codes over time (national trend)
# Output to csv files
# Datasets used:			input.csv
# Datasets created: 		None
# Other output: tables: 'tb*.csv'
# Log file: log-03-createnattrends.txt
#
## ==============================================================================
## open log connection to file
sink(here::here("logs", "log-03-createnattrends.txt"))
## library
library(tidyverse)
library(here)
query_dates=seq(as.Date("2019-07-01"),length=18,by="months")
query_dates <- paste0(query_dates)
## import and pre-process cohort data
df_input <- read_csv(
here::here("output",paste0("input_measures_",  query_dates[1], ".csv")))
df_input <- df_input %>% mutate(month=query_dates[1])
for (datenow in tail(query_dates,-1)){
df_input_now <- read_csv(
here::here("output",paste0("input_measures_",  datenow, ".csv")))
df_input_now <- df_input_now %>% mutate(month=datenow)
df_input <- df_input %>% bind_rows(df_input_now)
}
df_input <- as.data.frame(df_input)
rm(df_input_now)
df_summary <- df_input %>%
group_by(month) %>%
summarise_at(vars(starts_with("GVC")),~sum(.,na.rm=T))
rm(df_input)
df_summary_long <- df_summary %>% pivot_longer(cols=starts_with("GVC"),
names_to="Code",
values_to="Count")
write.csv(df_summary_long,paste0(here::here("output"),"/sc03_tb01_nattrends.csv"))
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
scale_x_date(date_breaks = "2 months",expand=c(0,0))  +
theme(axis.text.x = element_text(angle = -90,vjust = 0))
ggsave(paste0(here::here("output"),"/sc03_fig01_nattrends.png"),width = 40, height = 20, dpi=300,units ="cm")
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,color=Code)) +
geom_line()
ggsave(paste0(here::here("output"),"/sc03_fig02_nattrends.png"),width = 40, height = 20, dpi=300,units ="cm")
## close log connection
sink()
# ##==============================================================================
# Analysis filename:			02-createtallytable-codes
# Project:				Pilot on video group clinics
# Author:					MF
# Date: 					08/01/2020
# Version: 				R
# Description:	Produce tally on instances of relevant codes
# Output to csv files
# Datasets used:			input.csv
# Datasets created: 		None
# Other output: tables: 'tb*.csv'
# Log file: log-02-createtallytable.txt
#
## ==============================================================================
## open log connection to file
sink(here::here("logs", "log-02-createtallytable.txt"))
## library
library(tidyverse)
library(here)
## import and pre-process cohort data
df_input <- read_csv(
here::here("output", "input_codes.csv"))
df_cleaned <- df_input %>%
pivot_longer(cols=starts_with("GVC"),
names_to="Code",
values_to="Instances") %>%
mutate("Had"=ifelse(is.na(Instances)|Instances==0,0,1)) %>%
pivot_wider(names_from=Code,values_from=c(Instances,Had)) %>%
mutate(practice=factor(practice),
stp=factor(stp),
patient_id=factor(patient_id)
)
# mutate(GVC01_had=ifelse(is.na(GVC_Xagrc)|GVC_Xagrc==0,0,1),
#        GVC02_had=ifelse(is.na(GVC_Y22b5)|GVC_Y22b5==0,0,1),
#        GVC03_had=ifelse(is.na(GVC_XaXcK)|GVC_XaXcK==0,0,1),
#        GVC03_had=ifelse(is.na(GVC_XaXcK)|GVC_XaXcK==0,0,1),
#        GVC03_had=ifelse(is.na(GVC_XaXcK)|GVC_XaXcK==0,0,1),
#        practice=factor(practice),
#        stp=factor(stp),
#        patient_id=factor(patient_id)
#        )
## National tally - no. instances and no. individual patients with instances
tb01_nat_tally <- df_cleaned %>% summarise(across(where(is.numeric),~sum(.x,na.rm=T)))
tb01_nat_tally <- tb01_nat_tally %>% mutate(population=nrow(df_cleaned),no_practices=n_distinct(df_cleaned$practice,na.rm=T))
#View(tb01_nat_tally)
## Practice tally - no practices with at least an instance
tb02_practice_flags <- df_cleaned %>% group_by(stp,practice) %>% summarise_at(vars(starts_with("Had")), ~ ifelse(sum(.)>0,1,0))
#View(tb02_practice_flags)
tb02_practice_flags_ <- pivot_longer(tb02_practice_flags,cols=starts_with("Had"),
names_to="code",
values_to="had_instance")
tb02_practice_flags_ <- tb02_practice_flags_ %>%
group_by(code) %>%
summarise(Present=sum(had_instance),Absent=n()-Present) %>%
pivot_longer(c("Present","Absent"),names_to="Instance presence",values_to="no_practices")
tb02_practice_flags_$`Instance presence` <- factor(tb02_practice_flags_$`Instance presence`)
ggplot(tb02_practice_flags_, aes(fill=`Instance presence`,x=code, y=no_practices,label=no_practices)) +
geom_bar( stat="identity")+
geom_text(aes(vjust=-1),position = position_stack(vjust = 0.2))+
theme(axis.text.x = element_text(angle = -90),text = element_text(size=15))+
labs(title="Portion of practices with code recorded",y="Count of practices",x="Code")
#https://stackoverflow.com/questions/6644997/showing-data-values-on-stacked-bar-chart-in-ggplot2
# ggplot(tb02_practice_flags_, aes(fill=had_instance, x=code)) +
#   geom_bar( stat="count")+
#   geom_text(stat='count', aes(label=..count..), vjust=-1)+
#   theme(axis.text.x = element_text(angle = -45),text = element_text(size=17))+
#   labs(title="Portion of practices with code recorded",y="Count of practices",x="Code")
ggsave(paste0(here::here("output"),"/sc02_fig01_practice_flags.png"),width = 40, height = 20, dpi=300,units ="cm")
## STP tally - no STPs with at least an instance
tb03_stp_flags <- df_cleaned %>% group_by(stp) %>% summarise_at(vars(ends_with("had")), ~ ifelse(sum(.)>0,1,0))
#View(tb03_stp_flags)
## Save
write.csv(tb01_nat_tally,paste0(here::here("output"),"/sc02_tb01_nat_tally.csv"))
write.csv(tb02_practice_flags,paste0(here::here("output"),"/sc02_tb02_practice_flags.csv"))
write.csv(tb03_stp_flags,paste0(here::here("output"),"/sc02_tb03_stp_flags.csv"))
## close log connection
sink()
# ##==============================================================================
# Analysis filename:			03-createnattrends_codes
# Project:				Pilot on video group clinics
# Author:					MF
# Date: 					17/01/2020
# Version: 				R
# Description:	Produce tally on instances of relevant codes over time (national trend)
# Output to csv files
# Datasets used:			input.csv
# Datasets created: 		None
# Other output: tables: 'tb*.csv'
# Log file: log-03-createnattrends.txt
#
## ==============================================================================
## open log connection to file
sink(here::here("logs", "log-03-createnattrends.txt"))
## library
library(tidyverse)
library(here)
query_dates=seq(as.Date("2019-07-01"),length=18,by="months")
query_dates <- paste0(query_dates)
## import and pre-process cohort data
df_input <- read_csv(
here::here("output",paste0("input_measures_",  query_dates[1], ".csv")))
df_input <- df_input %>% mutate(month=query_dates[1])
for (datenow in tail(query_dates,-1)){
df_input_now <- read_csv(
here::here("output",paste0("input_measures_",  datenow, ".csv")))
df_input_now <- df_input_now %>% mutate(month=datenow)
df_input <- df_input %>% bind_rows(df_input_now)
}
df_input <- as.data.frame(df_input)
rm(df_input_now)
df_summary <- df_input %>%
group_by(month) %>%
summarise_at(vars(starts_with("GVC")),~sum(.,na.rm=T))
rm(df_input)
df_summary_long <- df_summary %>% pivot_longer(cols=starts_with("GVC"),
names_to="Code",
values_to="Count")
write.csv(df_summary_long,paste0(here::here("output"),"/sc03_tb01_nattrends.csv"))
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
scale_x_date(date_breaks = "2 months",expand=c(0,0))  +
theme(axis.text.x = element_text(angle = -90,vjust = 0))
ggsave(paste0(here::here("output"),"/sc03_fig01_nattrends.png"),width = 40, height = 20, dpi=300,units ="cm")
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,color=Code)) +
geom_line()
ggsave(paste0(here::here("output"),"/sc03_fig02_nattrends.png"),width = 40, height = 20, dpi=300,units ="cm")
## close log connection
sink()
# ##==============================================================================
# Analysis filename:			03-createnattrends_codes
# Project:				Pilot on video group clinics
# Author:					MF
# Date: 					17/01/2020
# Version: 				R
# Description:	Produce tally on instances of relevant codes over time (national trend)
# Output to csv files
# Datasets used:			input.csv
# Datasets created: 		None
# Other output: tables: 'tb*.csv'
# Log file: log-03-createnattrends.txt
#
## ==============================================================================
## open log connection to file
sink(here::here("logs", "log-03-createnattrends.txt"))
## library
library(tidyverse)
library(here)
query_dates=seq(as.Date("2019-07-01"),length=18,by="months")
query_dates <- paste0(query_dates)
## import and pre-process cohort data
df_input <- read_csv(
here::here("output",paste0("input_measures_",  query_dates[1], ".csv")))
df_input <- df_input %>% mutate(month=query_dates[1])
for (datenow in tail(query_dates,-1)){
df_input_now <- read_csv(
here::here("output",paste0("input_measures_",  datenow, ".csv")))
df_input_now <- df_input_now %>% mutate(month=datenow)
df_input <- df_input %>% bind_rows(df_input_now)
}
df_input <- as.data.frame(df_input)
rm(df_input_now)
df_summary <- df_input %>%
group_by(month) %>%
summarise_at(vars(starts_with("GVC")),~sum(.,na.rm=T))
rm(df_input)
df_summary_long <- df_summary %>% pivot_longer(cols=starts_with("GVC"),
names_to="Code",
values_to="Count")
write.csv(df_summary_long,paste0(here::here("output"),"/sc03_tb01_nattrends.csv"))
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,fill=Code)) +
geom_bar(stat="identity") +
facet_wrap(~Code,nrow=2,scales="free_y") +
scale_x_date(date_breaks = "2 months",expand=c(0,0))  +
theme(axis.text.x = element_text(angle = -90,vjust = 0))
ggsave(paste0(here::here("output"),"/sc03_fig01_nattrends.png"),width = 40, height = 20, dpi=300,units ="cm")
ggplot(data=df_summary_long,aes(x=as.Date(month),y=Count,color=Code)) +
geom_line()
ggsave(paste0(here::here("output"),"/sc03_fig02_nattrends.png"),width = 40, height = 20, dpi=300,units ="cm")
## close log connection
sink()
ggplot(data=df_summary_long %>% mutate(month=as.Date(month)),aes(x=month,y=Count,color=Code)) +
geom_line()
ggplot(data=df_summary_long %>% mutate(month=as.Date(month)),aes(x=month,y=Count,color=Code)) +
geom_line()+
scale_x_date(date_breaks = "2 months",expand=c(0,0))
ggplot(data=df_summary_long %>% mutate(month=as.Date(month)),aes(x=month,y=Count,color=Code)) +
geom_line()+
scale_x_date(date_breaks = "2 months",expand=c(0,0))+
theme(axis.text.x = element_text(angle = -90,vjust = 0))
ggsave(paste0(here::here("output"),"/sc03_fig02_nattrends.png"),width = 40, height = 20, dpi=300,units ="cm")
ggplot(data=df_summary_long %>% mutate(month=as.Date(month)) %>% filter(Code!="GVC_comparator_consult_count"),aes(x=month,y=Count,color=Code)) +
geom_line()+
scale_x_date(date_breaks = "2 months",expand=c(0,0))+
theme(axis.text.x = element_text(angle = -90,vjust = 0))
ggsave(paste0(here::here("output"),"/sc03_fig02_nattrends.png"),width = 40, height = 20, dpi=300,units ="cm")
